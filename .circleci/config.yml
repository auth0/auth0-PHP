version: 2.1

commands:
  setup:
    steps:
      - run:
          name: Configure environment
          command: |
            apk update && apk add npm gcc autoconf make musl-dev oniguruma-dev gnupg

      - checkout

      - run:
          name: Configure environment
          command: |
            docker-php-ext-install posix
            docker-php-ext-install pcntl
            docker-php-ext-install mbstring
            docker-php-ext-enable posix pcntl mbstring

  setup-composer:
    steps:
      - run:
          name: Install dependencies
          command: |
            EXPECTED_CHECKSUM="$(php -r 'copy("https://composer.github.io/installer.sig", "php://stdout");')"
            php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
            ACTUAL_CHECKSUM="$(php -r "echo hash_file('sha384', 'composer-setup.php');")"

            if [ "$EXPECTED_CHECKSUM" != "$ACTUAL_CHECKSUM" ]; then
                >&2 echo 'ERROR: Invalid installer checksum'
                rm composer-setup.php
                exit 1
            fi

            php composer-setup.php --quiet
            RESULT=$?
            rm composer-setup.php

            php composer.phar install --no-interaction --prefer-dist

  setup-pcov:
    steps:
      - run:
          name: Configure pcov
          command: |
            pecl install pcov
            docker-php-ext-enable pcov

  setup-snyk:
    steps:
      - run:
          name: Configure snyk
          command: |
            npm install -g snyk

  run-phpinsights:
    steps:
      - run:
          name: Run code quality analysis (PHP Insights)
          command: php -d memory-limit=2G ./vendor/bin/phpinsights -v --no-interaction --min-quality=100 --min-complexity=50 --min-architecture=100 --min-style=100

  run-phpstan:
    steps:
      - run:
          name: Run static code analysis (PHPStan)
          command: php -d memory_limit=2G ./vendor/bin/phpstan analyse --ansi

  run-psalm:
    steps:
      - run:
          name: Run static code analysis (Psalm)
          command: php -d memory_limit=2G ./vendor/bin/psalm --threads=$(nproc)

  run-pest:
    steps:
      - run:
          name: Run unit tests (Pest)
          command: php -d memory_limit=2G ./vendor/bin/pest --stop-on-failure --min=100

  run-infection:
    steps:
      - run:
          name: Run mutation tests (Infection)
          command: php -d memory_limit=2G ./vendor/bin/infection --threads=$(nproc) --test-framework=pest --no-progress --only-covered --min-msi=48 --min-covered-msi=70

  run-snyk:
    steps:
      - run:
          name: Run vulnerabilities tests (Snyk)
          command: snyk test --org=auth0-sdks --project-name=auth0-PHP

jobs:
  php:
    parameters:
      php:
        type: string
    docker:
      - image: php:<< parameters.php >>-cli-alpine
    steps:
      - setup
      - setup-composer
      - setup-pcov
      - run-phpinsights
      - run-phpstan
      - run-psalm
      - run-pest
  snyk:
    parameters:
      php:
        type: string
    docker:
      - image: php:<< parameters.php >>-cli-alpine
    steps:
      - setup
      - setup-composer
      - setup-snyk
      - run-snyk
  infection:
    parameters:
      php:
        type: string
    docker:
      - image: php:<< parameters.php >>-cli-alpine
    steps:
      - setup
      - setup-composer
      - setup-pcov
      - run-infection

workflows:
  test:
    jobs:
      - php:
          matrix:
            parameters:
              php: ["7.4", "8.0", "8.1.0RC3"]
      - infection:
          matrix:
            parameters:
              php: ["7.4"]
      - snyk:
          type: approval
          matrix:
            parameters:
              php: ["7.4", "8.0"]
          context:
            - snyk-env

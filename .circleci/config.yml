version: 2.1

commands:
  prepare:
    steps:
      - checkout
      - run:
          name: Setup Environment
          command: |
            apk update
            apk add gcc make autoconf musl-dev oniguruma-dev node
            pecl install pcov
            docker-php-ext-enable pcov
            docker-php-ext-install posix
            docker-php-ext-install pcntl
            docker-php-ext-install mbstring
            npm install -g snyk
      - run:
          name: Install Composer
          command: |
            wget https://raw.githubusercontent.com/composer/getcomposer.org/76a7060ccb93902cd7576b67264ad91c8a2700e2/web/installer -O - -q | php -- --quiet
            mv composer.phar /usr/local/bin/composer
      - run:
          name: Install Dependencies
          command: |
            composer install --no-interaction --prefer-dist << parameters.composer >>
            composer update --prefer-dist --no-interaction

  run-phpinsights:
    steps:
      - run:
          name: Run code quality analysis (PHP Insights)
          command: php ./vendor/bin/phpinsights -v --no-interaction --min-quality=90 --min-complexity=50 --min-architecture=90 --min-style=90

  run-phpstan:
    steps:
      - run:
          name: Run static code analysis (PHPStan)
          command: php ./vendor/bin/phpstan analyse --ansi --memory-limit 512M

  run-psalm:
    steps:
      - run:
          name: Run static code analysis (Psalm)
          command: php ./vendor/bin/psalm --threads=$(nproc)

  run-pest:
    steps:
      - run:
          name: Run unit tests (Pest)
          command: php ./vendor/bin/pest --stop-on-failure --min=80 --coverage-clover=build/coverage/coverage.xml --coverage-xml=build/coverage/coverage-xml --log-junit=build/coverage/junit.xml
      - persist_to_workspace:
          root: .
          paths:
            - src
            - tests
            - infection.json.dist
            - phpunit.xml.dist
            - build
            - vendor

  run-snyk:
    steps:
      - run:
          name: Run vulnerabilities tests (Snyk)
          command: snyk test --org=auth0-sdks --project-name=auth0-PHP

  run-infection:
    steps:
      - run:
          name: Run mutation tests (Infection)
          command: php ./vendor/bin/infection --skip-initial-tests --threads=$(nproc) --test-framework=pest --coverage=build/coverage --no-progress --min-msi=48 --min-covered-msi=70

jobs:
  run-tests:
    parameters:
      php:
        type: string
      composer:
        type: string
      snyk:
        type: boolean
        default: false
      infection:
        type: boolean
        default: false
    docker:
      - image: php:<< parameters.php >>-cli-alpine
    steps:
      - prepare
      - run-phpinsights
      - run-phpstan
      - run-psalm
      - run-pest
      - run-snyk
      - when:
          condition:
            and:
              - equal: [true, << parameters.snyk >>]
          steps:
            - run-snyk
      - when:
          condition:
            and:
              - equal: [main, <<pipeline.git.branch >>]
              - equal: [true, << parameters.infection >>]
          steps:
            - run-infection

workflows:
  run-tests:
    jobs:
      - run-tests:
          name: run-tests-7.4
          php: "7.4"
          composer: ""
          snyk: true
          infection: true
      - run-tests:
          name: run-tests-8.0
          php: "8.0"
          composer: ""
      - run-tests:
          when: never
          name: run-tests-8.1
          php: "8.1.0beta1"
          composer: "--ignore-platform-reqs"
